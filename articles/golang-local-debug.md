# Локальная отладка облачных функций

Не так давно я начал использовать облачные функции. В основном это внутренние проекты, для обработки вебхуков от CRM, мессенджеров, социальных сетей. Несмотря на то, что основным языком для разработки приложений у нас является C#, для функций мы начали использовать Golang. Для этого было несколько причин. Первый раз мы работали с Yandex.Cloud, и на тот момент у него не было поддержки C# для облачных функций. А из всех доступных языков у Golang было наименьшее время холодного старта. На данный момент мы переехали на AWS, но продолжаем писать на go.

Перед нами открывался дивный новый мир, и у нас было так много вопросов... А конкретно три:

* Как локально проверить работу функции?
* Сколько будет стоить?

В качестве примера рассмотрим ~~сферического коня в вакууме~~ функцию, котораю обрабатывает вебхук от телеграма, записывает идентификатор чата в базу данных и отвечает пользователю.

<details>
    <summary>main.go</summary>
</details>


<details>
    <summary>handler.go</summary>
</details>


## Как локально проверить работу функции?

Разрабатывая свои первые функции, я использовал следующую незамысловатую конструкцию

<details>
    <summary>Незамысловатая конструкция</summary>
</details>

При запуске проекта мы проверяем наличие заранее определенного флага в переменных окружения, и в случае его наличия запускаем локальный вебсервер с одним роутом, который обрабатывается наших обработчиком функции. 

<details>
    <summary>Полный код main.go</summary>
</details>

Затем отправляя запросы через юнит-тесты или Postman мы проверяем работу нашей функции.

На этом можно было и закончить, но подход не лишен недостатков.
Мы имеем шаблонный код, который необходимо переносить из проекта в проект. И который никому не нужен в production. К тому же, он не позволяет оценить (позволяет, но нужно еще некоторое количество незамысловатых конструкций) потребление ресурсов, чтобы узнать стоимость потребления ресурсов.

Я ленив, и переносить данный код из проекта в проект мне надоело. Мне нужно было другое решение. 


## t *testing.T

А давайте создадим моки для всех сервисов и напишем юнит-тесты?

<details>
    <summary>handler_test.go<summary>
</details>

Да, теперь мы можем протестировать нашу функцию. Моки позволяют нам имитировать различные сервисы (даже AWS).

Но какой ценой?

Мы любим тесты, любим зеленые флажки и Кента Бека. 
Но мы не готовы писать юнит-тесты на все-все что есть в нашем приложении. По той причине, что это тоже код и его тоже нужно поддерживать. Особенно учитывая особенности Go, когда при каждом изменении интерфейса нужно заново генерировать моки. И опять же данный вариант не позволяет оценить потребление ресурсов, чтобы узнать стоимость потребления ресурсов.


Казалось бы вот этот момент, когда совершенство найдено.
Но одна вещь не давала покоя. Моки это не реальные объекты. Через них можно сымитировать любое поведение если знать, что имитировать. Например задержки ответов от внешних сервисов.

Второй момент это окружение разработки. Как .net-разработчики мы используем windows. Функции работают на linux. Проблем с функциями из-за этого у нас не было, но в прошлом мы сталкивались c проблемой, когда наше чудесное приложение на кроссплатформенном .net core в docker-контейнере пыталось неуспешно вызвать winapi (через один из nuget-пакетов).

Что собственно предлагает AWS? 




Второй вариант 

Отладка через юнит тесты



Третий вариант

Создание проекта

Минимальная конфигурация

Код приложения

Отладчик Delve

Подключаем dynamodb

Итоги